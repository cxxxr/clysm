# Implementation Plan: Stage 1 Runtime Environment

**Branch**: `001-stage1-runtime` | **Date**: 2025-12-30 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/001-stage1-runtime/spec.md`

## Summary

Build a Node.js execution environment for the Stage 1 Clysm compiler (dist/clysm-stage1.wasm, 24.5KB). Provide FFI host functions for file I/O (`clysm:fs`) and console output (`clysm:io`), invoke the `_start` export to initialize the runtime, and create shell scripts for Stage 1 execution and Stage 2 generation. This enables verification of the bootstrap pipeline's functional compiler output.

## Technical Context

**Language/Version**: JavaScript (Node.js 20+ with WasmGC support)
**Primary Dependencies**: Node.js fs module, existing host-shim (io-shim.js, fs-shim.js), wasm-tools (validation)
**Storage**: N/A (file I/O via FFI functions to host filesystem)
**Testing**: Shell scripts with exit code verification, wasm-tools validate
**Target Platform**: Node.js 20+ (WasmGC required), Linux/macOS
**Project Type**: Single (CLI tool)
**Performance Goals**: Scripts execute in under 10 seconds for basic operations
**Constraints**: Node.js 20+ mandatory for WasmGC support; no browser/web runtime
**Scale/Scope**: Single developer use, single Stage 1 module execution

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. WasmGC-First | ✓ PASS | Stage 1 uses WasmGC types (confirmed via `wasm-tools print`) |
| II. Lispオブジェクト表現 | ✓ PASS | Handled by compiler; host shim only provides FFI |
| III. クロージャ実装 | ✓ PASS | Handled by compiler; host shim unaffected |
| IV. Wasm制御フロー | ✓ PASS | Handled by compiler; host shim calls `_start` export |
| V. シャローバインディング | ✓ PASS | Handled by compiler runtime initialization |
| VI. Tiered Eval/JIT | ✓ PASS | This feature enables Tier 2 (dynamic Wasm execution) |
| VII. TDD | ⚠ REQUIRES | Shell scripts must verify exit codes and output |
| VIII. Nix-First | ✓ PASS | Project uses `flake.nix`; devShell has Node.js, wasm-tools |
| IX. ANSI CL仕様参照 | N/A | Host shim is JavaScript; no CL spec references needed |

**Gate Result**: PASS (TDD requirement addressed in task planning)

### Post-Phase 1 Re-Check

| Principle | Status | Verification |
|-----------|--------|--------------|
| I. WasmGC-First | ✓ PASS | No linear memory used; all data via WasmGC externref |
| VI. Tiered Eval/JIT | ✓ PASS | research.md confirms Tier 2 execution pattern |
| VII. TDD | ✓ ADDRESSED | contracts/cli-interface.md defines testable exit codes |
| VIII. Nix-First | ✓ PASS | No new dependencies; uses existing flake.nix |

**Post-Design Gate Result**: PASS

## Project Structure

### Documentation (this feature)

```text
specs/001-stage1-runtime/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/           # Phase 1 output
└── tasks.md             # Phase 2 output
```

### Source Code (repository root)

```text
host-shim/
├── io-shim.js           # Existing: clysm:io FFI implementations
├── fs-shim.js           # Existing: clysm:fs FFI implementations
├── stage1-host.js       # Existing: Stage 0 → Stage 1 generation
├── stage1-runner.js     # NEW: Execute Stage 1 with FFI
└── README.md            # Update with Stage 1 usage

scripts/
├── run-stage1.sh        # NEW: Convenience script to run Stage 1
├── generate-stage2.sh   # NEW: Use Stage 1 to compile Clysm → Stage 2
└── verify-fixpoint.sh   # Existing: Compare Stage 1 and Stage 2

dist/
├── clysm-stage1.wasm    # Existing: 24.5KB Stage 1 compiler
├── clysm-stage2.wasm    # Output: Generated by Stage 1
└── stage2-report.json   # Output: Compilation report

tests/
└── integration/
    └── stage1-runtime/  # NEW: Integration tests for Stage 1 execution
```

**Structure Decision**: Extend existing `host-shim/` and `scripts/` directories. No new top-level directories needed. Tests go in `tests/integration/` following existing pattern.

## Complexity Tracking

> No constitution violations requiring justification.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| (none) | N/A | N/A |
