# Contract: Wasm Module Output

**Feature**: 022-wasm-import-optimization
**Date**: 2025-12-25
**Type**: Binary Format Contract

## Overview

This contract defines the expected structure of Wasm modules generated by Clysm, specifically regarding the presence or absence of the Import section.

---

## Wasm Section Order (Reference)

Per WebAssembly spec, sections must appear in this order:

| ID | Section | Required |
|----|---------|----------|
| 1 | Type | Yes |
| 2 | Import | **Conditional** (new behavior) |
| 3 | Function | Yes |
| 4 | Table | No |
| 5 | Memory | No |
| 6 | Global | If globals defined |
| 7 | Export | Yes |
| 8 | Start | No |
| 9 | Element | If lambda functions |
| 10 | Code | Yes |
| 11 | Data | No |
| 12 | Data Count | No |
| 13 | Tag | If exceptions |

---

## Contract: Import Section Presence

### C1: No I/O Usage → No Import Section

**Condition**: When compiled expression does not use any I/O functions

**Expected Output**:
- Wasm module validates with `wasm-tools validate`
- Wasm module executes in wasmtime without `--dir` or host imports
- Section ID 2 (Import) is NOT present in module

**Test Expression**: `(+ 1 2)`

**Validation**:
```bash
# Compile
sbcl --eval '(ql:quickload :clysm)' \
     --eval '(clysm/compiler:compile-to-wasm (quote (+ 1 2)) :output "/tmp/add.wasm")' \
     --quit

# Validate
wasm-tools validate /tmp/add.wasm

# Check no import section (section ID 2)
wasm-tools print /tmp/add.wasm | grep -c "import" # Should be 0

# Execute
wasmtime --invoke _start /tmp/add.wasm  # Should return 3
```

### C2: I/O Usage → Import Section Present

**Condition**: When compiled expression uses I/O functions (print, format, etc.)

**Expected Output**:
- Wasm module validates with `wasm-tools validate`
- Wasm module requires host-shim for execution
- Section ID 2 (Import) IS present with `clysm:io` imports

**Test Expression**: `(print "hello")`

**Validation**:
```bash
# Compile
sbcl --eval '(ql:quickload :clysm)' \
     --eval '(clysm/compiler:compile-to-wasm (quote (print "hello")) :output "/tmp/hello.wasm")' \
     --quit

# Validate structure
wasm-tools validate /tmp/hello.wasm

# Check import section present
wasm-tools print /tmp/hello.wasm | grep "import" # Should show imports

# Execute with shim
node host-shim/run-wasm.js /tmp/hello.wasm  # Should print "hello"
```

---

## Contract: wasmtime Execution

### C3: Arithmetic Expressions Execute Directly

**Condition**: Simple arithmetic without I/O

**Expected**: wasmtime returns correct numeric result

| Expression | Expected Return |
|------------|-----------------|
| `(+ 1 2)` | 3 |
| `(* 7 6)` | 42 |
| `(- 100 58)` | 42 |
| `(/ 10 2)` | 5 |

**Validation**:
```bash
# Each expression should compile and execute:
wasmtime --invoke _start /tmp/expr.wasm
# Exit code 0, stdout shows return value
```

### C4: Import Error for I/O Without Shim

**Condition**: I/O expression executed in wasmtime without shim

**Expected**: Clear error message about missing imports

**Test**:
```bash
# This should fail with "unknown import: clysm:io::write-char" or similar
wasmtime --invoke _start /tmp/hello.wasm 2>&1 | grep -i "unknown import"
```

---

## Contract: Module Size

### C5: Non-I/O Modules Are Smaller

**Condition**: Module without I/O should not include import section overhead

**Expected**:
- Module size for `(+ 1 2)` ≤ Module size when imports were unconditionally included
- Approximate savings: ~50-100 bytes (import section size)

**Validation**:
```bash
# Compare sizes
ls -la /tmp/add.wasm  # Should be smaller than before this feature
```

---

## Contract: Backward Compatibility

### C6: Existing I/O Code Unchanged

**Condition**: Code that previously used I/O continues to work

**Expected**:
- Same behavior when executed with host-shim
- Import section structure unchanged
- No changes required to host-shim

**Test**: Run existing integration tests that use I/O functions.
