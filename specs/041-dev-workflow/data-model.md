# Data Model: Development Workflow Establishment

**Date**: 2025-12-27
**Feature**: 041-dev-workflow

## Overview

This document defines the data structures for the Clysm development workflow feature. All structures are designed to work in both SBCL (bootstrap) and Stage 1+ (self-hosted) environments.

## Core Entities

### SourceModule

Represents a single Lisp source file with metadata for compilation.

```lisp
(defstruct source-module
  "A source module to be compiled."
  (path "" :type string)              ; Absolute file path
  (relative-path "" :type string)     ; Path relative to project root
  (package nil :type (or symbol null)) ; Package name from in-package
  (mtime 0 :type integer)             ; File modification timestamp (Unix epoch)
  (hash "" :type string)              ; Content hash (SHA-256 hex)
  (forms nil :type list)              ; Parsed S-expressions
  (form-count 0 :type integer)        ; Number of top-level forms
  (dependencies nil :type list)       ; List of required module paths
  (status :pending :type keyword))    ; :pending, :compiling, :compiled, :failed, :skipped
```

**Field Notes**:
- `path`: Absolute path for file I/O operations
- `relative-path`: For display and cache keys
- `hash`: Used to detect content changes even if mtime unchanged
- `status`: Tracks compilation progress for error recovery

### DependencyGraph

Tracks relationships between modules for compilation ordering.

```lisp
(defstruct dependency-graph
  "Module dependency graph for compilation ordering."
  (modules nil :type list)              ; List of source-module
  (path-index nil :type hash-table)     ; path -> source-module
  (order nil :type list)                ; Topological order (path list)
  (dependents nil :type hash-table)     ; path -> list of dependent paths
  (dependencies nil :type hash-table))  ; path -> list of dependency paths
```

**Operations**:
```lisp
;; Get modules that need recompilation when a module changes
(defun get-dependents (graph path)
  "Return all modules that depend on PATH (directly or transitively)."
  ...)

;; Get compilation order for a subset of modules
(defun get-compilation-order (graph paths)
  "Return PATHS sorted in compilation order."
  ...)

;; Check for cycles
(defun detect-cycles (graph)
  "Return list of cycle paths, or nil if acyclic."
  ...)
```

### CompilationCache

Persisted state for incremental compilation.

```lisp
(defstruct compilation-cache
  "Persistent cache for incremental compilation."
  (version 1 :type integer)             ; Cache format version
  (timestamp "" :type string)           ; Last save time (ISO-8601)
  (project-root "" :type string)        ; Project root path
  (modules nil :type hash-table)        ; path -> cached-module
  (dependency-graph nil :type t))       ; Serialized graph snapshot
```

**Cached Module Entry**:
```lisp
(defstruct cached-module
  "Cached compilation result for a single module."
  (path "" :type string)                ; Relative path
  (mtime 0 :type integer)               ; Modification time when compiled
  (hash "" :type string)                ; Content hash when compiled
  (compiled-size 0 :type integer)       ; Size of compiled Wasm bytes
  (compiled-bytes nil :type t)          ; Wasm bytes (or nil if not cached)
  (compile-time-ms 0 :type integer)     ; Compilation duration
  (form-results nil :type list))        ; Per-form success/failure
```

### CompilationResult

Outcome of compiling a single module.

```lisp
(defstruct compilation-result
  "Result of compiling a single module."
  (module nil :type source-module)      ; The module that was compiled
  (success-p nil :type boolean)         ; Overall success
  (wasm-bytes nil :type t)              ; Generated Wasm bytes (or nil)
  (byte-count 0 :type integer)          ; Size of generated bytes
  (form-count 0 :type integer)          ; Total forms in module
  (forms-compiled 0 :type integer)      ; Forms successfully compiled
  (forms-failed 0 :type integer)        ; Forms that failed
  (forms-skipped 0 :type integer)       ; Forms skipped (e.g., metadata)
  (errors nil :type list)               ; List of compilation-error
  (warnings nil :type list)             ; List of compilation-warning
  (compile-time-ms 0 :type integer))    ; Time to compile
```

### CompilationError

Detailed error information for diagnostics.

```lisp
(defstruct compilation-error
  "Error during compilation with location info."
  (severity :error :type keyword)       ; :error or :warning
  (message "" :type string)             ; Human-readable message
  (path "" :type string)                ; Source file path
  (line 0 :type integer)                ; Line number (1-based, 0 if unknown)
  (column 0 :type integer)              ; Column number (1-based, 0 if unknown)
  (form nil :type t)                    ; The form that caused the error
  (operator nil :type symbol)           ; The operator that failed (for grouping)
  (suggestion nil :type (or string null))) ; Optional fix suggestion
```

### CompilationSession

State for a single compilation run.

```lisp
(defstruct compilation-session
  "State of an active compilation session."
  (start-time 0 :type integer)          ; Session start (Unix epoch ms)
  (project-root "" :type string)        ; Project root path
  (output-path "" :type string)         ; Target output file
  (input-patterns nil :type list)       ; Original glob patterns
  (modules nil :type list)              ; All modules to consider
  (dirty-modules nil :type list)        ; Modules requiring recompilation
  (results nil :type list)              ; List of compilation-result
  (errors nil :type list)               ; Aggregated errors
  (progress nil :type progress-info)    ; Current progress state
  (options nil :type compilation-options)) ; Session options
```

### CompilationOptions

User-specified compilation settings.

```lisp
(defstruct compilation-options
  "Options controlling compilation behavior."
  (output "" :type string)              ; Output file path
  (verbose nil :type boolean)           ; Verbose output
  (force nil :type boolean)             ; Force full recompilation
  (continue-on-error t :type boolean)   ; Continue after errors
  (cache-path "" :type string)          ; Cache directory path
  (progress-callback nil :type t))      ; Function for progress updates
```

### ProgressInfo

Progress tracking for UI feedback.

```lisp
(defstruct progress-info
  "Current compilation progress."
  (phase :init :type keyword)           ; :init, :reading, :analyzing, :compiling, :linking, :done
  (total-modules 0 :type integer)       ; Total modules to process
  (current-module 0 :type integer)      ; Index of current module
  (current-path "" :type string)        ; Path of current module
  (percentage 0.0 :type single-float)   ; Overall progress 0.0-100.0
  (message "" :type string))            ; Status message
```

## Entity Relationships

```
CompilationSession
    ├── CompilationOptions
    ├── ProgressInfo
    ├── SourceModule[] (all modules)
    │   └── (forms, dependencies)
    ├── DependencyGraph
    │   └── (order, dependents)
    └── CompilationResult[] (per module)
        ├── SourceModule (ref)
        └── CompilationError[]

CompilationCache (persisted)
    ├── CachedModule[] (per path)
    └── DependencyGraph snapshot
```

## State Transitions

### Module Status

```
                ┌──────────────┐
                │   :pending   │ (initial)
                └──────┬───────┘
                       │ start compile
                ┌──────▼───────┐
                │  :compiling  │
                └──────┬───────┘
         ┌─────────────┼─────────────┐
         │             │             │
    ┌────▼────┐   ┌────▼────┐   ┌────▼────┐
    │:compiled│   │ :failed │   │:skipped │
    └─────────┘   └─────────┘   └─────────┘
    (success)     (error)       (dep failed)
```

### Session Phase

```
:init → :reading → :analyzing → :compiling → :linking → :done
   │        │           │            │           │
   └────────┴───────────┴────────────┴───────────┴──→ (error at any phase)
```

## Validation Rules

### SourceModule
- `path` must be non-empty and refer to an existing file
- `mtime` must be positive integer
- `hash` must be 64-character hex string (SHA-256)
- `status` must be one of: `:pending`, `:compiling`, `:compiled`, `:failed`, `:skipped`

### DependencyGraph
- `order` must contain exactly the paths of all `modules`
- No cycles allowed (detect-cycles returns nil)
- `dependents` and `dependencies` must be consistent inverses

### CompilationCache
- `version` must match current cache format version
- `project-root` must match current project root
- All cached module paths must exist in filesystem

### CompilationError
- `line` and `column` are 0 if location unknown
- `severity` must be `:error` or `:warning`

## Cache File Format

**Location**: `.clysm-cache/compilation-cache.sexp`

```lisp
(:version 1
 :timestamp "2025-12-27T12:00:00Z"
 :project-root "/home/user/src/clysm3"
 :modules
 (("src/clysm/backend/leb128.lisp"
   :mtime 1735300800
   :hash "a1b2c3d4e5f6..."
   :compiled-size 1234
   :dependencies nil)
  ("src/clysm/backend/sections.lisp"
   :mtime 1735300900
   :hash "b2c3d4e5f6g7..."
   :compiled-size 2345
   :dependencies ("src/clysm/backend/leb128.lisp")))
 :dependency-order
 ("src/clysm/backend/leb128.lisp"
  "src/clysm/backend/sections.lisp"
  ...))
```

## Performance Considerations

1. **Lazy Loading**: Forms are parsed on-demand, not during discovery
2. **Incremental Hashing**: Use streaming hash for large files
3. **Cache Pruning**: Remove entries for deleted files on load
4. **Graph Caching**: Dependency graph computed once, cached with project

## Migration Notes

Structures extend existing `clysm/stage1` types where possible:
- `source-module` extends existing reader structures
- `compilation-result` extends existing progress structures
- New types follow same naming conventions
